<div class="bg-slate-50 min-h-screen p-4 sm:p-6 md:p-8">
  <!-- Page Header Card -->
  <header class="mb-8 bg-white rounded-xl shadow-sm border border-slate-200 p-6">
    <!-- Back Button -->
    <button
      (click)="goBack()"
      class="flex items-center text-sm text-indigo-600 font-semibold hover:text-indigo-800 transition-colors mb-4"
    >
      <i class="pi pi-arrow-left mr-2 text-xs"></i>
      Back to all series
    </button>

    @if (testSeries) {
    <div>
      <p class="text-sm font-semibold uppercase tracking-wider text-indigo-500 mb-1">
        {{ testSeries.category }}
      </p>
      <h1 class="text-4xl font-bold text-slate-800">{{ testSeries.name }}</h1>
      <p class="text-slate-500 mt-2 max-w-2xl">{{ testSeries.description }}</p>

      <!-- Overall Progress -->
      <div class="mt-4 max-w-sm">
        <div class="flex justify-between text-sm text-slate-500 mb-2">
          <span>Overall Progress</span>
          <span class="font-medium">
            {{ testSeries.testsCompleted }} / {{ testSeries.testsTotal }} Tests
          </span>
        </div>
        <div class="w-full bg-slate-200 rounded-full h-2">
          <div
            class="bg-indigo-600 h-2 rounded-full"
            [style.width.%]="(testSeries.testsCompleted / (testSeries.testsTotal || 1)) * 100"
          ></div>
        </div>
      </div>
    </div>
    } @else {
    <!-- Skeleton Loading for Header -->
    <div>
      <p-skeleton width="8rem" height="1rem" class="mb-2"></p-skeleton>
      <p-skeleton width="60%" height="2.5rem" class="mb-3"></p-skeleton>
      <p-skeleton width="90%" height="1rem" class="mb-2"></p-skeleton>
      <p-skeleton width="75%" height="1rem" class="mb-4"></p-skeleton>
      <div class="mt-4 max-w-sm">
        <p-skeleton width="100%" height="0.5rem" borderRadius="16px"></p-skeleton>
      </div>
    </div>
    }
  </header>

  <!-- Stage Tabs & Test List -->
  @if (testSeries) {

  <!-- Check if stages exist -->
  @if (testSeries.stages && testSeries.stages.length > 0) {

  <div class="mt-6">
    <p-tabs [value]="testSeries.stages[0].id" class="custom-tabs">
      <!-- Default to first stage ID -->

      <!-- Tab Headers -->
      <p-tablist>
        @for (stage of testSeries.stages; track stage.id) {
        <p-tab [value]="stage.id" class="font-medium px-6">
          {{ stage.name }}
        </p-tab>
        }
      </p-tablist>

      <!-- Tab Content -->
      <p-tabpanels class="bg-transparent p-0 mt-6">
        @for (stage of testSeries.stages; track stage.id) {
        <p-tabpanel [value]="stage.id">
          <div class="space-y-4">
            <!-- Loop through tests inside THIS stage -->
            @for (test of stage.tests; track test.id; let i = $index) {
            <div
              class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 flex flex-col md:flex-row items-center hover:shadow-md hover:border-indigo-300 transition-all duration-300"
            >
              <!-- Icon Column -->
              <div class="flex-shrink-0 mb-4 md:mb-0 md:mr-6">
                @if (isTestLocked(i)) {
                <i class="pi pi-lock text-4xl text-slate-400"></i>
                } @else {
                <i
                  class="pi text-4xl"
                  [ngClass]="{
                    'text-green-500 pi-check-circle': test.status === 'Completed',
                    'text-yellow-500 pi-arrow-circle-right': test.status === 'Continue',
                    'text-indigo-500 pi-play-circle': test.status === 'Not Started'
                  }"
                ></i>
                }
              </div>

              <!-- Test Details -->
              <div class="flex-grow text-center md:text-left mb-4 md:mb-0">
                <div class="flex items-center justify-center md:justify-start space-x-3 mb-1">
                  <h3 class="text-xl font-bold text-slate-800">{{ test.title }}</h3>

                  <!-- Status Tags -->
                  @if (isTestLocked(i)) {
                  <span
                    class="text-xs font-medium px-2.5 py-0.5 rounded-full bg-slate-100 text-slate-600"
                    >Locked</span
                  >
                  } @else if (test.status === 'Completed') {
                  <span
                    class="text-xs font-medium px-2.5 py-0.5 rounded-full bg-green-100 text-green-800"
                    >Completed</span
                  >
                  } @else if (test.status === 'Continue') {
                  <span
                    class="text-xs font-medium px-2.5 py-0.5 rounded-full bg-yellow-100 text-yellow-800"
                    >In Progress</span
                  >
                  } @else {
                  <span
                    class="text-xs font-medium px-2.5 py-0.5 rounded-full bg-blue-100 text-blue-800"
                    >New</span
                  >
                  }
                </div>
                <p class="text-sm text-slate-500">
                  {{ test.duration_minutes }} Mins | {{ test.number_of_questions }} Questions | Max
                  Marks: {{ test.marks_correct * test.number_of_questions }}
                </p>
              </div>

              <!-- Action Buttons -->
              <div
                class="flex-shrink-0 flex items-center space-x-3 w-full md:w-auto justify-center md:justify-end"
              >
                @if (isTestLocked(i)) {
                <button
                  class="py-2 px-4 text-white font-semibold rounded-lg flex items-center text-sm bg-slate-500 hover:bg-slate-600 transition-colors"
                  (click)="handleLockClick(test.id)"
                >
                  <i class="pi pi-lock mr-2 text-xs"></i> Unlock
                </button>
                } @else if (test.status === 'Completed') {
                <button
                  class="py-2 px-4 border border-indigo-600 text-indigo-600 font-semibold rounded-lg hover:bg-indigo-50 transition-colors text-sm flex items-center"
                  (click)="navigateToResults(test.resultId)"
                >
                  <i class="pi pi-chart-bar mr-2 text-xs"></i> View Results
                </button>
                <button
                  class="py-2 px-4 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg transition-colors text-sm flex items-center"
                  (click)="navigateToTest(test.id)"
                >
                  <i class="pi pi-refresh mr-2 text-xs"></i> Retake
                </button>
                } @else {
                <button
                  class="py-2 px-4 text-white font-semibold rounded-lg transition-colors flex items-center text-sm"
                  [ngClass]="
                    test.status === 'Continue'
                      ? 'bg-yellow-500 hover:bg-yellow-600'
                      : 'bg-indigo-600 hover:bg-indigo-700'
                  "
                  (click)="navigateToTest(test.id)"
                >
                  <i
                    class="pi mr-2 text-xs"
                    [ngClass]="test.status === 'Continue' ? 'pi-arrow-right' : 'pi-play'"
                  ></i>
                  {{ test.status === 'Continue' ? 'Continue' : 'Start Test' }}
                </button>
                }
              </div>
            </div>
            }

            <!-- Empty State for Stage -->
            <!-- FIX: Added safe navigation operator ?.length -->
            @if (stage.tests?.length === 0) {
            <div
              class="text-center py-12 bg-white rounded-xl border border-slate-200 border-dashed"
            >
              <p class="text-slate-400">No tests available in {{ stage.name }} yet.</p>
            </div>
            }
          </div>
        </p-tabpanel>
        }
      </p-tabpanels>
    </p-tabs>
  </div>

  } @else {
  <!-- Fallback if no stages (or flat structure) -->
  <div class="text-center py-10">
    <p class="text-slate-500">No test stages found for this series.</p>
  </div>
  } } @else {
  <!-- Skeleton List Loading -->
  <div class="mt-10 space-y-4">
    <p-skeleton width="12rem" height="2rem" class="mb-6"></p-skeleton>
    @for (i of [1, 2, 3]; track i) {
    <div
      class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 flex flex-col md:flex-row items-center"
    >
      <div class="flex-shrink-0 mb-4 md:mb-0 md:mr-6">
        <p-skeleton shape="circle" size="3rem"></p-skeleton>
      </div>
      <div class="flex-grow w-full mb-4 md:mb-0">
        <p-skeleton width="60%" height="1.5rem" class="mb-2"></p-skeleton
        ><p-skeleton width="40%" height="1rem"></p-skeleton>
      </div>
      <div class="flex-shrink-0"><p-skeleton width="120px" height="2.5rem"></p-skeleton></div>
    </div>
    }
  </div>
  }
</div>
