<!-- This component assumes it's rendered inside your main app layout -->
<p-toast></p-toast>
<div class="bg-slate-50 min-h-screen p-4 sm:p-6 md:p-8">
  <div class="max-w-6xl mx-auto">
    <!-- Page Header -->
    <header class="mb-8">
      <h1 class="text-4xl font-bold text-slate-800">Account Settings</h1>
      <p class="text-slate-500 mt-2">Manage your profile, password, and subscription.</p>
    </header>

    <!-- Main Layout (Sidebar + Content) -->
    <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
      <!-- Left Sidebar: Navigation -->
      <aside class="lg:col-span-1">
        <!-- Profile Card -->
        <div
          class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 flex items-center mb-6"
        >
          @if (authService.currentUser | async; as user) {
          <p-avatar
            image="https://placehold.co/64x64/E0E7FF/4338CA?text={{ user['first_name'][0] }}"
            size="xlarge"
            shape="circle"
            styleClass="mr-4 border-2 border-white ring-2 ring-indigo-300"
          ></p-avatar>
          <div class="min-w-0 flex-1">
            <h3
              class="font-bold text-lg text-slate-800 truncate"
              title="{{ user['first_name'] }} {{ user['last_name'] }}"
            >
              {{ user['first_name'] }} {{ user['last_name'] }}
            </h3>
            <p class="text-sm text-slate-500 truncate" title="{{ user['email'] }}">
              {{ user['email'] }}
            </p>
          </div>
          } @else {
          <div class="flex items-center w-full">
            <p-skeleton shape="circle" size="4rem" styleClass="mr-4"></p-skeleton>
            <div class="flex-1">
              <p-skeleton width="60%" height="1.2rem" styleClass="mb-2"></p-skeleton>
              <p-skeleton width="80%" height="0.9rem"></p-skeleton>
            </div>
          </div>
          }
        </div>

        <!-- Navigation Links -->
        <nav
          class="bg-white p-4 rounded-xl shadow-sm border border-slate-200 flex flex-col space-y-1"
        >
          <button (click)="setActiveTab('profile')" [ngClass]="getNavClass('profile')">
            <i class="pi pi-user mr-3"></i> Profile
          </button>
          <button (click)="setActiveTab('security')" [ngClass]="getNavClass('security')">
            <i class="pi pi-lock mr-3"></i> Password
          </button>
          <button (click)="setActiveTab('subscription')" [ngClass]="getNavClass('subscription')">
            <i class="pi pi-star mr-3"></i> Subscription
          </button>
        </nav>
      </aside>

      <!-- Right: Content Area -->
      <main class="lg:col-span-3">
        <!-- Profile Settings Panel -->
        @if (activeTab === 'profile') {
        <div class="bg-white rounded-xl shadow-sm border border-slate-200">
          <header class="p-6 border-b border-slate-200">
            <h2 class="text-xl font-bold text-slate-800">Profile Information</h2>
            <p class="text-sm text-slate-500 mt-1">Update your personal details.</p>
          </header>
          @if (authService.currentUser | async; as user) {
          <form [formGroup]="profileForm" (ngSubmit)="onProfileSubmit()" class="p-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <!-- First Name -->
              <div class="mb-2">
                <label for="firstName" class="block text-sm font-medium text-slate-600 mb-2"
                  >First Name</label
                >
                <input
                  id="firstName"
                  type="text"
                  pInputText
                  formControlName="firstName"
                  class="w-full"
                />
              </div>
              <!-- Last Name -->
              <div class="mb-2">
                <label for="lastName" class="block text-sm font-medium text-slate-600 mb-2"
                  >Last Name</label
                >
                <input
                  id="lastName"
                  type="text"
                  pInputText
                  formControlName="lastName"
                  class="w-full"
                />
              </div>
              <!-- Email (Read-only) -->
              <div class="mb-2">
                <div class="flex justify-between items-center mb-2">
                  <div class="flex items-center gap-2">
                    <label for="email" class="block text-sm font-medium text-slate-600">
                      Email Address
                    </label>
                    <button
                      type="button"
                      (click)="toggleEmailEdit()"
                      class="text-slate-400 hover:text-indigo-600 focus:outline-none transition-colors"
                      pTooltip="Edit Email"
                      tooltipPosition="top"
                    >
                      <i
                        class="pi"
                        [class.pi-pencil]="!isEmailEditing"
                        [class.pi-times]="isEmailEditing"
                      ></i>
                    </button>
                  </div>

                  @if (user['is_email_verified']) {
                  <span
                    class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-md text-xs font-bold bg-emerald-50 text-emerald-700 border border-emerald-200 shadow-sm"
                  >
                    <i class="pi pi-verified text-emerald-600"></i>
                    Verified
                  </span>
                  } @else {
                  <button
                    type="button"
                    (click)="requestVerification()"
                    [disabled]="verificationSent || verificationLoading"
                    class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-md text-xs font-bold bg-amber-50 text-amber-700 border border-amber-200 shadow-sm hover:bg-amber-100 transition-all cursor-pointer disabled:opacity-60 disabled:cursor-not-allowed group"
                  >
                    @if (verificationLoading) {
                    <i class="pi pi-spin pi-spinner"></i>
                    } @else if (verificationSent) {
                    <i class="pi pi-check"></i>
                    } @else {
                    <i
                      class="pi pi-exclamation-circle text-amber-600 group-hover:text-amber-800"
                    ></i>
                    }

                    {{ verificationSent ? 'Link Sent' : 'Verify Now' }}
                  </button>
                  }
                </div>

                <div class="relative">
                  <input
                    id="email"
                    type="email"
                    pInputText
                    formControlName="email"
                    class="w-full text-slate-700 transition-colors"
                    [ngClass]="{
                      '!bg-slate-50 text-slate-500': !isEmailEditing,
                      'bg-white border-indigo-500 ring-2 ring-indigo-200': isEmailEditing,
                      'border-amber-300 ring-1 ring-amber-100':
                        !user['is_email_verified'] && !verificationSent && !isEmailEditing
                    }"
                    [readOnly]="!isEmailEditing"
                  />
                  @if (!isEmailEditing) {
                  <i
                    class="pi pi-lock absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 text-xs"
                  ></i>
                  }
                </div>
                @if (isEmailEditing) {
                <div
                  class="flex items-start gap-2 mt-2 px-3 py-2 bg-amber-50 text-amber-700 rounded-lg text-xs border border-amber-200 animate-fade-in"
                >
                  <i class="pi pi-exclamation-triangle mt-0.5"></i>
                  <p>
                    <span class="font-bold">Warning:</span> Changing your email will require you to
                    verify the new address again. Your current verified status will be lost.
                  </p>
                </div>
                } @if (!user['is_email_verified']) { @if (verificationSent) {
                <div class="mt-1.5 flex flex-wrap items-center gap-3 animate-fade-in">
                  <p class="text-xs text-emerald-600 flex items-center gap-1">
                    <i class="pi pi-send text-[10px]"></i>
                    Link sent! Check inbox.
                  </p>
                  <button
                    type="button"
                    (click)="requestVerification()"
                    [disabled]="verificationLoading"
                    class="text-xs text-indigo-600 font-bold hover:text-indigo-800 underline focus:outline-none disabled:opacity-50 disabled:cursor-not-allowed"
                  >
                    {{ verificationLoading ? 'Sending...' : 'Resend Link' }}
                  </button>
                </div>
                } @else {
                <p class="text-xs text-amber-600 mt-1.5">
                  Your email is unverified. Secure your account to prevent lockout.
                </p>
                } }
              </div>
              <!-- Phone -->
              <div class="mb-2">
                <label for="phone" class="block text-sm font-medium text-slate-600 mb-2"
                  >Phone</label
                >
                <div class="relative">
                  <input
                    id="phone"
                    type="tel"
                    pInputText
                    formControlName="phone"
                    class="w-full !bg-slate-50 text-slate-500"
                    [readOnly]="true"
                  />
                  <i
                    class="pi pi-lock absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 text-xs"
                  ></i>
                </div>
              </div>
            </div>
            <div class="mt-6 text-right">
              <button
                pButton
                [label]="saveLoading ? 'Saving...' : 'Save Changes'"
                type="submit"
                [loading]="saveLoading"
                [disabled]="!profileForm.dirty || !profileForm.valid || saveLoading"
              ></button>
            </div>
          </form>
          } @else {
          <div class="p-6">
            <!-- Skeleton for Form -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div class="mb-2">
                <p-skeleton width="6rem" styleClass="mb-2"></p-skeleton>
                <p-skeleton height="2.5rem"></p-skeleton>
              </div>
              <div class="mb-2">
                <p-skeleton width="6rem" styleClass="mb-2"></p-skeleton>
                <p-skeleton height="2.5rem"></p-skeleton>
              </div>
              <div class="mb-2">
                <p-skeleton width="6rem" styleClass="mb-2"></p-skeleton>
                <p-skeleton height="2.5rem"></p-skeleton>
              </div>
              <div class="mb-2">
                <p-skeleton width="6rem" styleClass="mb-2"></p-skeleton>
                <p-skeleton height="2.5rem"></p-skeleton>
              </div>
            </div>
            <div class="mt-6 text-right">
              <p-skeleton width="8rem" height="2.5rem" styleClass="ml-auto"></p-skeleton>
            </div>
          </div>
          }
        </div>
        }

        <!-- Security / Password Panel -->
        @if (activeTab === 'security') {
        <div class="bg-white rounded-xl shadow-sm border border-slate-200">
          <header class="p-6 border-b border-slate-200">
            <h2 class="text-xl font-bold text-slate-800">Change Password</h2>
            <p class="text-sm text-slate-500 mt-1">
              For your security, please do not share your password.
            </p>
          </header>
          <form [formGroup]="passwordForm" (ngSubmit)="onPasswordSubmit()" class="p-6 max-w-lg">
            <!-- Current Password -->
            <div class="mb-4">
              <label for="currentPassword" class="block text-sm font-medium text-slate-600 mb-2"
                >Current Password</label
              >
              <input
                id="currentPassword"
                type="password"
                pInputText
                formControlName="currentPassword"
                class="w-full"
                placeholder="••••••••"
              />
            </div>
            <!-- New Password -->
            <div class="mb-4">
              <label for="newPassword" class="block text-sm font-medium text-slate-600 mb-2"
                >New Password</label
              >
              <input
                id="newPassword"
                type="password"
                pInputText
                formControlName="newPassword"
                class="w-full"
                placeholder="••••••••"
              />
            </div>
            <!-- Confirm Password -->
            <div class="mb-4">
              <label for="confirmPassword" class="block text-sm font-medium text-slate-600 mb-2"
                >Confirm New Password</label
              >
              <input
                id="confirmPassword"
                type="password"
                pInputText
                formControlName="confirmPassword"
                class="w-full"
                placeholder="••••••••"
              />
              @if (passwordForm.errors?.['passwordMismatch'] &&
              passwordForm.get('confirmPassword')?.touched) {
              <p class="text-xs text-red-500 mt-1">Passwords do not match.</p>
              }
            </div>
            <div class="mt-6 text-right">
              <button
                pButton
                label="Update Password"
                type="submit"
                [disabled]="!passwordForm.valid"
              ></button>
            </div>
          </form>
        </div>
        }

        <!-- Subscription Panel -->
        @if (activeTab === 'subscription') {
        <div class="bg-white rounded-xl shadow-sm border border-slate-200">
          <header class="p-6 border-b border-slate-200">
            <h2 class="text-xl font-bold text-slate-800">My Subscription</h2>
            <p class="text-sm text-slate-500 mt-1">Manage your plan and billing details.</p>
          </header>
          <div class="p-6">
            @if (authService.currentUser | async; as user) {
            <!-- PRO ACTIVE STATE -->
            @if (user.is_pro_active) {
            <div
              class="relative overflow-hidden rounded-2xl bg-gradient-to-br from-indigo-600 to-violet-600 text-white shadow-xl"
            >
              <!-- Decorative Circles -->
              <div
                class="absolute top-0 right-0 -mr-16 -mt-16 w-64 h-64 bg-white opacity-10 rounded-full blur-3xl"
              ></div>
              <div
                class="absolute bottom-0 left-0 -ml-16 -mb-16 w-48 h-48 bg-white opacity-10 rounded-full blur-2xl"
              ></div>

              <div class="relative z-10 p-8">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center">
                  <div>
                    <div
                      class="inline-flex items-center gap-2 bg-white/20 backdrop-blur-sm px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wider mb-4 border border-white/10"
                    >
                      <i class="pi pi-star-fill text-amber-300"></i>
                      <span>Pro Active</span>
                    </div>
                    <h3 class="text-3xl font-bold mb-2">My Subscription</h3>
                    <p class="text-indigo-100 max-w-lg">
                      You have full access to all premium features, including unlimited tests,
                      detailed AI analysis, and exclusive study material.
                    </p>
                  </div>
                  <div
                    class="mt-6 md:mt-0 bg-white/10 backdrop-blur-md rounded-xl p-4 text-center border border-white/10"
                  >
                    <p class="text-xs text-indigo-200 uppercase tracking-wide mb-1">Renews On</p>
                    <p class="text-xl font-bold">
                      {{ user['pro_expiry_date'] | date : 'd MMM, yyyy' }}
                    </p>
                  </div>
                </div>

                <div class="mt-8 border-t border-white/10 pt-6 flex flex-wrap gap-6">
                  <div class="flex items-center gap-3">
                    <div
                      class="w-10 h-10 rounded-full bg-white/10 flex items-center justify-center"
                    >
                      <i class="pi pi-shield text-xl"></i>
                    </div>
                    <div>
                      <p class="font-bold">Premium Support</p>
                      <p class="text-xs text-indigo-200">Priority assistance</p>
                    </div>
                  </div>
                  <div class="flex items-center gap-3">
                    <div
                      class="w-10 h-10 rounded-full bg-white/10 flex items-center justify-center"
                    >
                      <i class="pi pi-bolt text-xl"></i>
                    </div>
                    <div>
                      <p class="font-bold">AI Analytics</p>
                      <p class="text-xs text-indigo-200">Deep performance insights</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="mt-8">
              <h4 class="font-bold text-slate-800 mb-4">Manage Subscription</h4>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <button
                  class="flex items-center justify-between p-4 rounded-xl border border-slate-200 hover:border-indigo-300 hover:bg-indigo-50 transition-all group"
                >
                  <div class="flex items-center gap-3">
                    <i class="pi pi-receipt text-slate-400 group-hover:text-indigo-600 text-xl"></i>
                    <span class="font-medium text-slate-700 group-hover:text-indigo-900"
                      >Billing History</span
                    >
                  </div>
                  <i class="pi pi-angle-right text-slate-300 group-hover:text-indigo-500"></i>
                </button>
                <button
                  class="flex items-center justify-between p-4 rounded-xl border border-slate-200 hover:border-red-300 hover:bg-red-50 transition-all group"
                >
                  <div class="flex items-center gap-3">
                    <i
                      class="pi pi-times-circle text-slate-400 group-hover:text-red-500 text-xl"
                    ></i>
                    <span class="font-medium text-slate-700 group-hover:text-red-900"
                      >Cancel Subscription</span
                    >
                  </div>
                  <i class="pi pi-angle-right text-slate-300 group-hover:text-red-500"></i>
                </button>
              </div>
            </div>

            } @else {
            <!-- FREE USER STATE (Upgrade Prompt) -->
            <div class="bg-white border border-slate-100 rounded-2xl overflow-hidden shadow-sm">
              <div class="p-8 text-center bg-slate-50 border-b border-slate-100">
                <div
                  class="w-16 h-16 bg-slate-200 rounded-full flex items-center justify-center mx-auto mb-4"
                >
                  <i class="pi pi-user text-3xl text-slate-500"></i>
                </div>
                <h3 class="text-2xl font-bold text-slate-800">Free Starter Plan</h3>
                <p class="text-slate-500 mt-2">You are currently on the basic free tier.</p>
              </div>

              <div class="p-8">
                <div
                  class="bg-gradient-to-r from-indigo-50 to-purple-50 rounded-xl p-6 border border-indigo-100 relative overflow-hidden"
                >
                  <div
                    class="flex flex-col md:flex-row items-center justify-between gap-6 relative z-10"
                  >
                    <div class="text-center md:text-left">
                      <h4 class="text-xl font-bold text-indigo-900 mb-2">Upgrade to Pro</h4>
                      <p class="text-indigo-700 text-sm mb-4">
                        Unlock the full potential of your preparation.
                      </p>
                      <ul class="space-y-2 text-left">
                        <li class="flex items-center gap-2 text-sm text-indigo-800">
                          <i class="pi pi-check-circle text-green-500"></i> Unlimited Mock Tests
                        </li>
                        <li class="flex items-center gap-2 text-sm text-indigo-800">
                          <i class="pi pi-check-circle text-green-500"></i> Advanced AI Analysis
                        </li>
                        <li class="flex items-center gap-2 text-sm text-indigo-800">
                          <i class="pi pi-check-circle text-green-500"></i> Ad-free Experience
                        </li>
                      </ul>
                    </div>
                    <button
                      pButton
                      label="View Plans & Pricing"
                      icon="pi pi-sparkles"
                      routerLink="/app/prices"
                      class="p-button-rounded p-button-lg bg-indigo-600 border-none shadow-lg shadow-indigo-200 hover:scale-105 transition-transform"
                    ></button>
                  </div>
                </div>
              </div>
            </div>
            } }
          </div>
        </div>
        }
      </main>
    </div>
  </div>
</div>
